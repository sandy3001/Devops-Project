- name: Ensure backup directory exists
  file:
    path: "{{ backup_dir }}"
    state: directory
    mode: 0755

- name: Backup existing patch script if present
  copy:
    src: "{{ patch_script_path }}"
    dest: "{{ backup_dir }}/patch.sh_{{ ansible_date_time.iso8601 }}"
    remote_src: yes
  ignore_errors: yes

- name: Deploy patch script
  copy:
    src: files/patch.sh
    dest: "{{ patch_script_path }}"
    owner: "{{ patch_owner }}"
    mode: "{{ patch_mode }}"
  register: patch_copy
  retries: "{{ max_retries }}"
  delay: 5
  until: patch_copy is succeeded
  notify: run patch

- name: Log failed hosts
  lineinfile:
    path: logs/failed_hosts.log
    line: "{{ inventory_hostname }}"
    create: yes
  when: patch_copy is failed
  delegate_to: localhost
